<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style>
		* {
			margin: 0;
			padding: 0;
		}
		.box {
			height: 5000px;
			width: 900px;
			border: 10px solid red;
		}
		.box2 {
			height: 200px;
			width: 500px;
			border: 1px solid blue;
			margin: 20px;
		}
		img {
			height: 200px;
			width: 500px;
		}
	</style>
</head>
<body>

	<div class="box">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img30.360buyimg.com/jdcms/s300x300_jfs/t1/23982/9/7469/150514/5c80c070Eb45718f6/60659631fceddbff.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img30.360buyimg.com/jdcms/s300x300_jfs/t1/23982/9/7469/150514/5c80c070Eb45718f6/60659631fceddbff.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img14.360buyimg.com/jdcms/s300x300_jfs/t1/16709/18/11977/138519/5c94af2aE82480755/d6598966c6f0ba89.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img12.360buyimg.com/jdcms/s300x300_jfs/t15031/103/700322623/189874/91dec497/5a34c985N8e301864.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img13.360buyimg.com/jdcms/s300x300_jfs/t1/7712/1/2323/420790/5bd1dd8dE6e0836c6/e5581fd462a8727d.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img13.360buyimg.com/jdcms/s300x300_jfs/t1/1611/30/3623/255950/5b9a2fccE51095f6b/bc3276fb5ca55a76.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img11.360buyimg.com/jdcms/s300x300_jfs/t1/17317/9/6670/193074/5c614213E9c865b06/49780b38bb6ffa0d.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img14.360buyimg.com/jdcms/s300x300_jfs/t27088/339/1797912342/172051/f2fa77fa/5bee7f2fNe06023a6.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img12.360buyimg.com/jdcms/s300x300_jfs/t1/26537/33/167/153150/5c0794a5E49aa252c/c91e7dfbaa1d24af.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img14.360buyimg.com/jdcms/s300x300_jfs/t1/21335/10/6789/81104/5c62be5fE491ecefa/92f40aff1dc62b53.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img30.360buyimg.com/jdcms/s300x300_jfs/t1/23982/9/7469/150514/5c80c070Eb45718f6/60659631fceddbff.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img13.360buyimg.com/jdcms/s300x300_jfs/t1/29855/5/12163/285280/5c95aab7Ee2dac43b/1f3c9c6e65dc547a.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img20.360buyimg.com/jdcms/s300x300_jfs/t3787/141/452477182/89108/2a3071c6/580d7fe0N69793577.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img11.360buyimg.com/jdcms/s300x300_jfs/t29701/298/50845793/75608/6fc51834/5be66843Nc5dcc971.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img14.360buyimg.com/jdcms/s300x300_jfs/t1/27222/35/11730/280307/5c918c6bEb0497f1a/0d9a9e6c5644f12a.jpg">
		<img src="./images/placepic.jpg" alt="" data-src=".https://img12.360buyimg.com/jdcms/s300x300_jfs/t21970/69/1089399192/370226/8ed3be5c/5b1f602dN39a7d804.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img11.360buyimg.com/jdcms/s300x300_jfs/t17188/325/2639631097/440562/f499f972/5b051e8cNa2ad9dfb.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img12.360buyimg.com/jdcms/s300x300_jfs/t26548/62/1349297548/239741/35496b1/5bc6f82bN552e43a9.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img10.360buyimg.com/jdcms/s300x300_jfs/t21757/135/737501918/389207/1a894ba8/5b167062N660fc1f9.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img12.360buyimg.com/jdcms/s300x300_jfs/t12490/67/2171199563/159593/28fd1ab8/5a34c8d6Naf388a3a.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img20.360buyimg.com/jdcms/s300x300_jfs/t1/11812/35/6871/206816/5c46b5f3E0caafffa/9cff72462175d8a0.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img13.360buyimg.com/jdcms/s300x300_jfs/t1/5470/4/9975/306652/5bc92a83E1731ad84/7eea5f8ed584943a.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img12.360buyimg.com/jdcms/s300x300_jfs/t25477/172/2438325355/354952/29d4889d/5be54435N636cd62c.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img12.360buyimg.com/jdcms/s300x300_jfs/t21568/58/1070505003/358275/54dfa78a/5b1f64c6N67d610df.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="https://img11.360buyimg.com/jdcms/s300x300_jfs/t5698/38/119010254/654902/2c6144ce/591d625cN6cf39912.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
		<img src="./images/placepic.jpg" alt="" data-src="./images/1.jpg">
	</div>


	<script>
		// 参考文章：https://juejin.im/post/583b10640ce463006ba2a71a
		// https://juejin.im/entry/594a483061ff4b006c12cea1

		// 元素在客户端方面相关的属性和懒加载的实现联系密切
	

		// window 上面的两个属性  window.pageYoffset === window.scrollY window.pageXoffset === scrollX
		// 只有 document 的高度超出浏览器的可视区域并且页面发生滚动的时候，上面的属性才会有值，否则不会有值
		// 一般来说如果 body 的 height 是视窗的高度，并且 overflow 设置为了 auto 或者是 scroll，上面的属性都不会有值，因为此时 document 的高度没有超出 window 的视窗

		// 怎么获得浏览器可视区域的宽高？？
		// window.innerHeight window.innerWidth 包括滚动条的宽高
		// window.outerHeight window.outerwidth 整个浏览器应用的宽高，包括标签栏和地址栏。

		// getBoundingClientRect(): 获取某个元素相对于视窗的位置 返回 DOMRect 对象
		// 其中返回的 DOMRect 对象中的 width 和 height 的值和 offsetHeight 和 offsetWidth 相同。
		// 还有 left(x) top(y) bottom right，都是相对于浏览器内容区域左上角的坐标点取值。left 和 top 是左上角，bottom 和 right 是右下角






		// 方式一：
		// let imageList = document.querySelectorAll('img')
		// imageList.forEach(item => {
		// 	const domRect = item.getBoundingClientRect()
		// 	if (domRect.top <= window.innerHeight) {
		// 		item.src = item.dataset.src
		// 	}
		// })
		
		function loadImg () {
			const restImg = []
			imageList.forEach(item => {
				// 判断 img 在可视区域内部方法一，局限性在于 img 的 offsetParent 必须是 body
				// var seeHeight = document.documentElement.clientHeight; //可见区域高度
			    // var scrollTop = document.documentElement.scrollTop || document.body.scrollTop; //滚动条距离顶部高度
			    // if (img[i].offsetTop < seeHeight + scrollTop) {

			    // 判断 img 在可视区域内部方法二 更简单，无局限性
				const domRect = item.getBoundingClientRect()
				if (domRect.top <= window.innerHeight) {
					item.src = item.dataset.src
					return ;
				}
				restImg.push(item)
			})
			// console.log(restImg.length)
			imageList = restImg; 
		}

		// 闭包保存状态, 通过节流函数来优化性能
		function wrapper (fn, delay) {
			let lastTime = Date.now()
			let timer = 0

					// 默认 4000 ms 执行一次
			function throttle () {
				if (timer) {
					clearTimeout(timer)
				}

				// 节流
				const nowTime = Date.now()
				// console.log(nowTime - lastTime)
				if (nowTime - lastTime > delay) {
					fn()
					lastTime = nowTime;
				}

				// 处理最后的加载
				timer = setTimeout(() => {
					loadImg()
				}, delay)
			}

			return throttle
		}

		// 每一次滚动都遍历所有的 img 元素
		// window.addEventListener('scroll', wrapper(loadImg, 700))



		// 方式二：
		// 实现图片的懒加载 getBoundingClientRect 只是一种方案
		// 第二种方案：IntersectionObserver
		const addObserverToImage = () => {
			// 提供了一种 异步观察目标元素 与其 祖先元素 或 顶级文档视窗(viewport) 交叉状态的方法
			const callback = (entities) => {
				console.log(entities)
				entities.forEach((entity) => {
					domRect = entity.boundingClientRect
					if (domRect.top <= window.innerHeight) {
						entity.target.src = entity.target.dataset.src
						intersectionObserver.unobserve(entity.target)
					}
				})
			}

			const intersectionObserver = new IntersectionObserver(callback)
			const images = document.querySelectorAll('img')

			images.forEach((img) => {
				intersectionObserver.observe(img)
			})
		}
		
		window.onload = () => {
			addObserverToImage()
		}

	</script>
</body>
</html>